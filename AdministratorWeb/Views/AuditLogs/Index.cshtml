@using AdministratorWeb.Models
@{
    ViewData["Title"] = "Audit Logs";
    var admins = ViewData["Admins"] as List<ApplicationUser> ?? new List<ApplicationUser>();
}

<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-white">Audit Logs</h1>
            <p class="text-slate-400 mt-1">Track all administrative actions and system events</p>
        </div>
        <button onclick="exportLogs()"
                class="inline-flex items-center px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-xl transition-all duration-200 shadow-lg">
            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
            Export CSV
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Admin Filter -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Admin User</label>
                <select id="filterUserId"
                        class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand-500">
                    <option value="">All Admins</option>
                    @foreach (var admin in admins)
                    {
                        <option value="@admin.Id">@admin.FullName</option>
                    }
                </select>
            </div>

            <!-- Action Type Filter -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Action Type</label>
                <select id="filterActionType"
                        class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand-500">
                    <option value="">All Actions</option>
                    <option value="Login">Login/Logout</option>
                    <option value="RequestAccepted">Request Management</option>
                    <option value="UserCreated">User Management</option>
                    <option value="SettingsUpdated">Settings</option>
                    <option value="PaymentProcessed">Payments</option>
                    <option value="RoomCreated">Room Management</option>
                </select>
            </div>

            <!-- Date From -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Date From</label>
                <input type="date" id="filterDateFrom"
                       class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand-500">
            </div>

            <!-- Date To -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Date To</label>
                <input type="date" id="filterDateTo"
                       class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand-500">
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mt-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">Search</label>
            <input type="text" id="filterSearch"
                   placeholder="Search descriptions, users, entities..."
                   class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand-500">
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 mt-4">
            <button onclick="applyFilters()"
                    class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg transition-all">
                <i data-lucide="filter" class="w-4 h-4 inline mr-1"></i>
                Apply Filters
            </button>
            <button onclick="clearFilters()"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                <i data-lucide="x" class="w-4 h-4 inline mr-1"></i>
                Clear
            </button>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-700/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                            Timestamp
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                            Action
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                            Description
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                            User
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                            Entity
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                            IP Address
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                            Status
                        </th>
                    </tr>
                </thead>
                <tbody id="logsTableBody" class="divide-y divide-slate-700/50">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <i data-lucide="file-search" class="w-16 h-16 text-slate-600 mx-auto mb-4"></i>
            <p class="text-slate-400 text-lg">No audit logs found</p>
            <p class="text-slate-500 text-sm mt-1">Try adjusting your filters</p>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="px-6 py-4 bg-slate-700/30 border-t border-slate-700/50 flex justify-between items-center">
            <div class="text-sm text-slate-400">
                Showing <span id="recordsInfo"></span>
            </div>
            <div id="paginationButtons" class="flex gap-2">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden text-center py-12">
        <i data-lucide="loader-2" class="w-8 h-8 text-brand-500 animate-spin mx-auto"></i>
        <p class="text-slate-400 mt-2">Loading audit logs...</p>
    </div>
</div>

@section Scripts {
<script>
    let currentPage = 1;
    const pageSize = 50;

    async function loadLogs(page = 1) {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');

        const userId = document.getElementById('filterUserId').value;
        const actionType = document.getElementById('filterActionType').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        const searchTerm = document.getElementById('filterSearch').value;

        const params = new URLSearchParams({
            page: page,
            pageSize: pageSize
        });

        if (userId) params.append('userId', userId);
        if (actionType) params.append('actionType', actionType);
        if (dateFrom) params.append('dateFrom', dateFrom);
        if (dateTo) params.append('dateTo', dateTo);
        if (searchTerm) params.append('searchTerm', searchTerm);

        try {
            const response = await fetch(`/AuditLogs/GetLogs?${params}`);
            const data = await response.json();

            if (data.logs.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('paginationContainer').classList.add('hidden');
                document.getElementById('logsTableBody').innerHTML = '';
            } else {
                renderLogs(data.logs);
                renderPagination(data.currentPage, data.totalPages, data.totalCount);
                document.getElementById('paginationContainer').classList.remove('hidden');
            }

            currentPage = page;
        } catch (error) {
            console.error('Failed to load audit logs:', error);
            alert('Failed to load audit logs. Please try again.');
        } finally {
            document.getElementById('loadingState').classList.add('hidden');
        }
    }

    function renderLogs(logs) {
        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = '';

        logs.forEach(log => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-700/30 transition-colors';

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                    ${formatDate(log.timestamp)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getActionTypeClass(log.actionType)}">
                        ${log.actionType}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-slate-300 max-w-md truncate" title="${log.actionDescription}">
                    ${log.actionDescription}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                    <div>${log.userName}</div>
                    <div class="text-xs text-slate-500">${log.userEmail}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                    ${log.entityType || '-'}<br>
                    <span class="text-xs">${log.entityName || ''}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                    ${log.ipAddress || '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${log.isSuccess
                        ? '<span class="text-emerald-400">✓ Success</span>'
                        : '<span class="text-red-400">✗ Failed</span>'}
                </td>
            `;

            tbody.appendChild(row);
        });

        lucide.createIcons();
    }

    function getActionTypeClass(actionType) {
        if (actionType.includes('Login')) return 'bg-purple-900/50 text-purple-300';
        if (actionType.includes('Request')) return 'bg-blue-900/50 text-blue-300';
        if (actionType.includes('User')) return 'bg-green-900/50 text-green-300';
        if (actionType.includes('Settings') || actionType.includes('Price') || actionType.includes('Company'))
            return 'bg-orange-900/50 text-orange-300';
        if (actionType.includes('Payment')) return 'bg-emerald-900/50 text-emerald-300';
        if (actionType.includes('Room')) return 'bg-cyan-900/50 text-cyan-300';
        if (actionType.includes('Robot')) return 'bg-indigo-900/50 text-indigo-300';
        return 'bg-slate-700 text-slate-300';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function renderPagination(currentPage, totalPages, totalCount) {
        const start = ((currentPage - 1) * pageSize) + 1;
        const end = Math.min(currentPage * pageSize, totalCount);

        document.getElementById('recordsInfo').textContent =
            `${start}-${end} of ${totalCount} records`;

        const buttonsDiv = document.getElementById('paginationButtons');
        buttonsDiv.innerHTML = '';

        // Previous button
        if (currentPage > 1) {
            const prevBtn = createPaginationButton('Previous', currentPage - 1);
            buttonsDiv.appendChild(prevBtn);
        }

        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = createPaginationButton(i, i, i === currentPage);
            buttonsDiv.appendChild(pageBtn);
        }

        // Next button
        if (currentPage < totalPages) {
            const nextBtn = createPaginationButton('Next', currentPage + 1);
            buttonsDiv.appendChild(nextBtn);
        }
    }

    function createPaginationButton(text, page, isActive = false) {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.onclick = () => loadLogs(page);
        btn.className = isActive
            ? 'px-3 py-1 bg-brand-600 text-white rounded-lg'
            : 'px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all';
        return btn;
    }

    function applyFilters() {
        loadLogs(1);
    }

    function clearFilters() {
        document.getElementById('filterUserId').value = '';
        document.getElementById('filterActionType').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        document.getElementById('filterSearch').value = '';
        loadLogs(1);
    }

    async function exportLogs() {
        const userId = document.getElementById('filterUserId').value;
        const actionType = document.getElementById('filterActionType').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        const params = new URLSearchParams();
        if (userId) params.append('userId', userId);
        if (actionType) params.append('actionType', actionType);
        if (dateFrom) params.append('dateFrom', dateFrom);
        if (dateTo) params.append('dateTo', dateTo);

        window.location.href = `/AuditLogs/Export?${params}`;
    }

    // Load logs on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadLogs(1);

        // Add Enter key support for search
        document.getElementById('filterSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFilters();
        });
    });
</script>
}
