================================================================================
EMAIL NOTIFICATION SYSTEM - COMPLETE IMPLEMENTATION PLAN
Laundry Robot Management System
================================================================================

GMAIL SMTP CREDENTIALS
-----------------------
Email: luandricorp@gmail.com
Password: hellocreamo123
Provider: Gmail SMTP
Host: smtp.gmail.com
Port: 587 (TLS) or 465 (SSL)
Note: May need to enable "Less secure app access" or generate App Password if 2FA enabled

================================================================================
IMPLEMENTATION PROMPT FOR FUTURE DEVELOPMENT
================================================================================

When implementing this email notification system, follow these steps carefully:

PHASE 1: SMTP SERVICE SETUP
----------------------------
1. Install NuGet packages:
   - MailKit (for SMTP client)
   - MimeKit (for email message construction)
   - Hangfire (optional - for background job processing)

2. Create EmailService class in Services/EmailService.cs:
   - Configure Gmail SMTP connection with credentials above
   - Implement SendEmailAsync(to, subject, htmlBody, textBody) method
   - Add retry logic for failed sends (3 attempts with exponential backoff)
   - Log all email attempts to console and database
   - Handle SMTP exceptions gracefully

3. Add email settings to appsettings.json:
   - SMTP host, port, username, password
   - From email address and display name
   - Enable/disable email sending (for dev/prod)
   - Rate limiting settings

4. Register EmailService in Program.cs dependency injection

PHASE 2: DATABASE SCHEMA
-------------------------
Create these tables with migrations:

Table: EmailQueue
- Id (int, PK)
- ToEmail (string, 256)
- ToName (string, 100)
- Subject (string, 500)
- HtmlBody (text)
- TextBody (text)
- Status (enum: Pending, Sent, Failed)
- Attempts (int, default 0)
- LastAttemptAt (datetime, nullable)
- SentAt (datetime, nullable)
- ErrorMessage (string, 1000, nullable)
- CreatedAt (datetime)

Table: EmailTemplates
- Id (int, PK)
- Name (string, 100, unique) - e.g., "payment_completed", "request_accepted"
- Subject (string, 500)
- HtmlContent (text)
- TextContent (text)
- Variables (string, 1000) - JSON array of template variable names
- IsActive (bool)
- CreatedAt (datetime)
- UpdatedAt (datetime)

Table: EmailLogs
- Id (int, PK)
- UserId (string, FK to AspNetUsers)
- EmailType (string, 100)
- ToEmail (string, 256)
- Subject (string, 500)
- SentAt (datetime)
- Delivered (bool)
- Opened (bool, nullable)
- ClickedLink (bool, nullable)
- CreatedAt (datetime)

Table: OTPCodes
- Id (int, PK)
- UserId (string, FK to AspNetUsers)
- Email (string, 256) - The new email address being verified
- Code (string, 6) - 6-digit numeric code
- ExpiresAt (datetime)
- Verified (bool, default false)
- VerifiedAt (datetime, nullable)
- CreatedAt (datetime)
- Index on: UserId, Email, Code, ExpiresAt

Table: EmailPreferences (User notification settings)
- Id (int, PK)
- UserId (string, FK to AspNetUsers, unique)
- EmailNotificationsEnabled (bool, default true)
- PaymentNotifications (bool, default true)
- RequestStatusNotifications (bool, default true)
- SecurityNotifications (bool, default true) - Always on, just for display
- MarketingNotifications (bool, default false)
- UpdatedAt (datetime)

PHASE 3: EMAIL TEMPLATE SYSTEM
-------------------------------
1. Create Views/EmailTemplates/ folder with HTML templates
2. Use Razor syntax for variable injection
3. Each template needs:
   - HTML version with inline CSS (for email client compatibility)
   - Plain text version (fallback)
   - Subject line with variable support

Templates to create:
- email_change_otp.cshtml
- payment_completed.cshtml
- refund_issued.cshtml
- request_accepted.cshtml
- request_declined.cshtml
- request_completed.cshtml
- delivery_started.cshtml
- delivery_completed.cshtml
- welcome.cshtml
- password_changed.cshtml
- payment_pending.cshtml

Template variables (use {{variable}} syntax):
- {{userName}} - User's full name
- {{email}} - User's email
- {{requestId}} - Laundry request ID
- {{amount}} - Payment amount
- {{robotName}} - Assigned robot name
- {{date}} - Formatted date
- {{time}} - Formatted time
- {{reason}} - Decline/refund reason
- {{otpCode}} - OTP verification code
- {{companyName}} - "LuandRi Laundry Service"
- {{supportEmail}} - "luandricorp@gmail.com"

PHASE 4: CORE FEATURES IMPLEMENTATION
--------------------------------------

FEATURE 1: EMAIL CHANGE WITH OTP VERIFICATION
Steps:
1. When user requests email change in profile:
   - Generate random 6-digit OTP code
   - Set expiration to DateTime.UtcNow.AddMinutes(10)
   - Save to OTPCodes table with new email and UserId
   - Send OTP email to NEW email address
   - Send notification to OLD email that change was requested
   - Store pending email in session/temporary field (don't update user.Email yet)

2. Create API endpoint: POST /api/user/verify-email-otp
   - Accept: userId, code, newEmail
   - Validate OTP code matches and not expired
   - If valid: Update user.Email, mark OTP as verified
   - If invalid: Return error
   - Delete/expire used OTP codes

3. Frontend: Show OTP input modal after email change request
   - 6-digit input boxes
   - Countdown timer showing expiration
   - Resend OTP button (with rate limiting)

FEATURE 2: PAYMENT COMPLETED EMAIL
Trigger: When admin marks payment as "Paid" in AccountingController
Location: AccountingController.cs, MarkAsPaid method (after SaveChanges)
Implementation:
- Get payment details and related request
- Load "payment_completed" email template
- Inject variables: userName, amount, requestId, paymentMethod, date
- Check if user has PaymentNotifications enabled
- Queue email in EmailQueue table
- Process queue in background

FEATURE 3: REFUND ISSUED EMAIL
Trigger: AccountingController.IssueRefund method
Implementation:
- Load "refund_issued" template
- Variables: userName, refundAmount, reason, originalAmount, requestId
- Queue email

FEATURE 4: REQUEST STATUS EMAILS
Triggers:
- RequestsController.AcceptRequest → "request_accepted"
- RequestsController.DeclineRequest → "request_declined"
- RequestsController.CompleteRequest → "request_completed"
- RequestsController.StartDelivery → "delivery_started"
Implementation:
- After each status change and SaveChanges
- Load appropriate template
- Inject relevant variables
- Check user RequestStatusNotifications preference
- Queue email

FEATURE 5: WELCOME EMAIL
Trigger: New user registration in AccountController
Implementation:
- After user created successfully
- Load "welcome" template
- Include account setup info, room assignment
- Always send (no preference check for first email)

FEATURE 6: PASSWORD CHANGED EMAIL
Trigger: User changes password
Implementation:
- Load "password_changed" template
- Include timestamp, IP address
- Always send (security notification)

PHASE 5: BACKGROUND EMAIL PROCESSING
-------------------------------------
Option A: Simple Background Task (No external dependencies)
1. Create EmailQueueProcessor service
2. Use IHostedService with Timer
3. Every 30 seconds, process pending emails from EmailQueue
4. Update status to Sent/Failed
5. Retry failed emails with exponential backoff

Option B: Hangfire (Recommended for production)
1. Install Hangfire.AspNetCore, Hangfire.MySqlStorage
2. Configure in Program.cs
3. Create recurring job to process email queue
4. Dashboard at /hangfire for monitoring

PHASE 6: USER PREFERENCES UI
-----------------------------
1. Add "Email Preferences" section to user profile page
2. Toggle switches for each notification category
3. Save preferences to EmailPreferences table
4. Show current email address
5. "Change Email" button triggers OTP flow

PHASE 7: ADMIN EMAIL MANAGEMENT
--------------------------------
1. Admin panel: /Admin/EmailTemplates
   - List all email templates
   - Edit template HTML/text/subject
   - Preview template with sample data
   - Test send to admin email

2. Admin panel: /Admin/EmailQueue
   - View pending/sent/failed emails
   - Retry failed emails manually
   - View email logs per user

3. Admin panel: /Admin/EmailSettings
   - Toggle email system on/off globally
   - Rate limiting settings
   - SMTP configuration test

PHASE 8: TESTING CHECKLIST
---------------------------
Before deploying:
[ ] Test Gmail SMTP connection
[ ] Send test email to verify delivery
[ ] Test OTP generation and validation
[ ] Test OTP expiration (10 minutes)
[ ] Test all email templates render correctly
[ ] Test HTML and plain text versions
[ ] Test email variables injection
[ ] Test user preferences toggles work
[ ] Test background email queue processing
[ ] Test retry logic for failed emails
[ ] Test rate limiting
[ ] Verify emails don't go to spam folder
[ ] Test on mobile email clients (Gmail, Outlook)
[ ] Test email logging to database
[ ] Load test: Send 100 emails simultaneously

PHASE 9: SECURITY CONSIDERATIONS
---------------------------------
1. Store SMTP password in environment variables or Azure Key Vault
2. Never log email content containing sensitive data
3. Rate limit OTP requests (max 3 per hour per user)
4. Expire OTP codes after use even if not expired by time
5. Hash OTP codes in database (optional, for extra security)
6. Use HTTPS for all email verification links
7. Sanitize user input before injecting into templates
8. Prevent email header injection attacks
9. Implement unsubscribe link in marketing emails

PHASE 10: MONITORING & ANALYTICS
---------------------------------
1. Log all email send attempts with status
2. Track email open rates (using tracking pixel)
3. Track link clicks (using redirect URLs)
4. Daily report of email statistics:
   - Emails sent
   - Delivery success rate
   - Failed emails count
   - Most common failure reasons
5. Alert admins if email sending fails consistently

IMPLEMENTATION ORDER (PRIORITY)
--------------------------------
1. CRITICAL - Email Change OTP (security feature)
2. HIGH - Payment Completed, Refund Issued (customer experience)
3. MEDIUM - Request status updates (nice to have)
4. LOW - Welcome email, password changed, announcements

GMAIL SPECIFIC SETUP NOTES
---------------------------
Before first email send:
1. Login to luandricorp@gmail.com
2. Enable 2-Step Verification (if not already)
3. Generate App Password:
   - Go to Google Account → Security → App passwords
   - Generate password for "Mail" app
   - Use this App Password instead of account password in appsettings.json
4. Alternatively: Enable "Less secure app access" (not recommended)
5. Test send from Gmail SMTP to verify account works

IMPORTANT REMINDERS
-------------------
- ALWAYS check user email preferences before sending (except security emails)
- ALWAYS log email attempts to EmailLogs table
- ALWAYS provide plain text version for accessibility
- NEVER expose email templates to SQL injection
- NEVER send passwords or sensitive data in email body
- ALWAYS use HTTPS for verification links
- ALWAYS expire OTP codes after use
- Test on multiple email clients before deploying

================================================================================
FEATURE LIST SUMMARY
================================================================================

1. AUTHENTICATION & SECURITY EMAILS
   ✓ Email Change Verification (OTP - 6 digits, 10 min expiration)
   ✓ Welcome Email (on registration)
   ✓ Password Changed Notification (security alert)

2. PAYMENT & FINANCIAL NOTIFICATIONS
   ✓ Payment Completed (with receipt details)
   ✓ Refund Issued (with amount and reason)
   ✓ Payment Pending Reminder (for unpaid requests)
   ✓ Manual Adjustment Created (admin adjustments)

3. LAUNDRY REQUEST STATUS NOTIFICATIONS
   ✓ Request Accepted (with robot assignment)
   ✓ Request Declined (with reason)
   ✓ Request Completed (laundry done)
   ✓ Delivery Started (robot on the way)
   ✓ Delivery Completed (items delivered)
   ✓ Ready for Pickup/Delivery (finished washing)

4. SYSTEM & ACCOUNT NOTIFICATIONS
   ✓ Low Balance Warning (if wallet implemented)
   ✓ Account Updated (profile changes)
   ✓ Service Announcements (optional)

5. ADMIN-SPECIFIC NOTIFICATIONS (Optional)
   ✓ New Request Alert (to admin email)
   ✓ Payment Received (confirmation)
   ✓ Daily/Weekly Summary Report

6. USER PREFERENCES MANAGEMENT
   ✓ Toggle email notifications on/off
   ✓ Per-category preferences:
     - Payment notifications
     - Request status updates
     - Marketing/announcements
     - Security alerts (always on)

================================================================================
END OF PLAN
================================================================================

Last Updated: 2025-01-16
Ready for Implementation: YES
Estimated Development Time: 2-3 days
Complexity: Medium-High
Dependencies: MailKit, MimeKit, Gmail SMTP access
